/*! jQuery Ctrl - v0.1.0-1 - 2014-08-01
* https://github.com/zengohm/jquery-ctrl
* Copyright (c) 2014 Zeng Ohm; Licensed MIT */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a("object"==typeof exports?require("jquery"):jQuery)}(function($){var NODE_STATUS_NORMAL=0,NODE_STATUS_COVER=1,NODE_STATUS_LAST=2,bindingTypes={},createCtrl=function(a,b){return{model:new ModelObject(a),ctrl:b}};$.ctrl=function(a,b){var c=$('[jq-ctrl="'+a+'"]');if(0===c.length)return!1;var d={},e={__refresh_binding__:function(){if(d&&d.onChangeTasks)for(var a=0;a<d.onChangeTasks.length;a++)d.onChangeTasks[a]()}};return b(e),d=createCtrl(e,c),bindingInit(d),!0};var bindingInit=function(a,b){a.bindings=[],a.onChangeTasks=b?b:[];var c=[],d=function(b){b.contents().andSelf().each(function(){if(-1===c.indexOf(this)){c.push(this);var b=NODE_STATUS_NORMAL;for(var e in bindingTypes)if(b|=bindingTypes[e](this,a.model,a.onChangeTasks),b&NODE_STATUS_LAST)break;b&NODE_STATUS_COVER||d($(this))}})};d(a.ctrl)};bindingTypes.jqRepeat=function(a,b,c){var d,e;if("function"!=typeof a.getAttribute||!(d=a.getAttribute("jq-repeat"))||!(e=d.match(/(\w+)\s+in\s+([\w\.]+)/)))return NODE_STATUS_NORMAL;var f=e[2],g=e[1],h=document.createComment("jq-if "+d+" start"),i=document.createComment("jq-if "+d+" end"),j=$(a).prop("outerHTML"),k=$(a).parent()[0];k.insertBefore(h,a),a.nextElementSibling?k.insertBefore(i,a.nextElementSibling):k.appendChild(i);var l=function(a){var b=$(j.replace(/\{\{([\w\.]+)\}\}/g,function(b,c){return null!==a.get(c)?a.get(c):b}));b.removeAttr("jq-repeat");var d=createCtrl(a.getData(),b);return bindingInit(d,c),b};return c.push(function(){for(var a=h.nextSibling;a!==i;)a=a.nextSibling,$(a.previousSibling).remove();var c=b.get(f);for(var d in c){var e=b.clone();e.set(g,c[d]),l(e).insertBefore(i)}}),c[c.length-1](null),NODE_STATUS_COVER},bindingTypes.text=function(a,b,c){if("#"===a.nodeName.substr(0,1)&&a.data.match(/\{\{[\w\.]+\}\}/)){var d=a.data;return c.push(function(){a.data=d.replace(/\{\{([\w\.]+)\}\}/g,function(a,c){return b.get(c)})}),c[c.length-1](),NODE_STATUS_COVER|NODE_STATUS_LAST}return NODE_STATUS_NORMAL},bindingTypes.model=function(a,b,c){var d;return a.getAttribute&&(d=a.getAttribute("jq-model"))?(c.push(function(c){return a===c?!1:void("checkbox"===a.type?$(a).attr({checked:b.get(d)?"checked":!1}):$(a).val(b.get(d)))}),c[c.length-1](),$(a).bind("keypress change keyup",function(){"checkbox"===this.type?b.set(d,this.checked):b.set(d,$(this).val());for(var a in c)c[a](this)}),NODE_STATUS_COVER):NODE_STATUS_NORMAL},bindingTypes.jqAttribute=function(a,b,c){if("function"!=typeof a.getAttribute)return NODE_STATUS_NORMAL;for(var d=["jq-src","jq-href"],e=function(a,d,e){c.push(function(){a.setAttribute(d.substr(3),e.replace(/\{\{([\w\.]+)\}\}/g,function(a,c){return b.get(c)}))})},f=0;f<d.length;f++){var g,h=d[f];(g=a.getAttribute(d[f]))&&(e(a,h,g),c[c.length-1]())}return NODE_STATUS_NORMAL},bindingTypes.otherAttribute=function(a,b,c){if("function"!=typeof a.getAttribute)return NODE_STATUS_NORMAL;for(var d=a.attributes,e=function(a,d,e){c.push(function(){a.setAttribute(d,e.replace(/\{\{([\w\.]+)\}\}/g,function(a,c){return b.get(c)}))})},f=0;f<d.length;f++)if("jq-"!==d[f].name.substr(0,3)){var g=d[f].value,h=d[f].name;g.match(/\{\{([\w\.]+)\}\}/)&&(e(a,h,g),c[c.length-1](null))}return NODE_STATUS_NORMAL},bindingTypes.jqStyle=function(a,b,c){var d;return"function"==typeof a.getAttribute&&(d=a.getAttribute("jq-style"))?(c.push(function(){$(a).css(b.get(d))}),c[c.length-1](null),NODE_STATUS_NORMAL):NODE_STATUS_NORMAL},bindingTypes.jqDisabled=function(a,b,c){var d;return"function"==typeof a.getAttribute&&(d=a.getAttribute("jq-disabled"))?(c.push(function(){$(a).attr("disabled",b.get(d))}),c[c.length-1](null),NODE_STATUS_NORMAL):NODE_STATUS_NORMAL},bindingTypes.jqSelect=function(a,b,c){var d;if("SELECT"!==a.nodeName||!(d=a.getAttribute("jq-options")))return NODE_STATUS_NORMAL;var e,f,g,h;if(e=d.match(/^(\w+)$/))f=null,g=null,h=e[1];else{if(!(e=d.match(/^(\w+),(\w+)\s+in\s+(\w+)$/)))return NODE_STATUS_NORMAL;f=e[1],g=e[2],h=e[3]}return c.push(function(){$(a).empty();var c=a.getAttribute("jq-model"),d=b.get(h);if(d&&"object"==typeof d[0]&&1===Object.keys(d[0]).length&&d[0][Object.keys(d[0])[0]]instanceof Array)for(var e in d){var i=$("<optgroup></optgroup>"),j=Object.keys(d[e])[0];i.attr("label",j);var k=d[e][j];if(null===f)for(var l in k)i.append("<option>"+k[l]+"</option>");else for(var m in k)i.append('<option value="'+k[m][f]+'">'+k[m][g]+"</option>");$(a).append(i)}else if(null===f)for(var n in d)$(a).append("<option>"+d[n]+"</option>");else for(var o in d)$(a).append('<option value="'+d[o][f]+'">'+d[o][g]+"</option>");$(a).val(b.get(c))}),c[c.length-1](null),$(a).removeAttr("jq-options"),NODE_STATUS_COVER},bindingTypes.jqIf=function(a,b,c){var d;if("function"!=typeof a.getAttribute||!(d=a.getAttribute("jq-if")))return NODE_STATUS_NORMAL;var e=document.createComment("jq-if "+d+" start"),f=document.createComment("jq-if "+d+" end"),g=$(a).parent()[0];g.insertBefore(e,a),a.nextElementSibling?g.insertBefore(f,a.nextElementSibling):g.appendChild(f);var h=new Function("model","with(model){return "+d+";}");return c.push(function(){$(a).remove(null,!0),h(b.getData())&&$(a).insertAfter(e)}),c[c.length-1](null),NODE_STATUS_NORMAL},bindingTypes.jqEvent=function(element,model,onChangeTasks){var types=["click","keypress","keyup","keydown","dbclick","mousedown","mouseup","mouseover","mousemove","mouseout","change","submit"],query,action=function(a,b,c){return function(){var d=model.get(b).apply(a,c);for(var e in onChangeTasks)onChangeTasks[e](a);return d}};for(var i in types){var type=types[i];if(element.getAttribute&&(query=element.getAttribute("jq-"+type))){var match=query.match(/^([\w\.]+)\((.*?)\)$/),funName=match[1],params=eval("["+match[2]+"]");$(element).bind(type,action(this,funName,params))}}return NODE_STATUS_NORMAL};var ModelObject=function(a){"undefined"!=typeof a&&a||(a={});var b=a;this.set=function(a,c){var d=a.split("."),e=d.pop(),f=b;for(var g in d)"undefined"==typeof f[d[g]]&&(f[d[g]]={}),f=f[d[g]];return f[e]=c,c},this.get=function(a){var c=a.split("."),d=b;for(var e in c)if(d=d[c[e]],"undefined"==typeof d)return null;return d},this.subModel=function(a){return new ModelObject(this.get(a))},this.getData=function(){return b},this.clone=function(){return new ModelObject($.extend(!0,{},b))}}});