/*! jQuery Ctrl - v0.1.0 - 2014-07-23
* https://github.com/zengohm/jquery-ctrl
* Copyright (c) 2014 Zeng Ohm; Licensed MIT */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a("object"==typeof exports?require("jquery"):jQuery)}(function(a){var b=0,c=1,d=2,e={},f=function(a,b){return{model:new h(a),ctrl:b}};a.ctrl=function(b,c){var d={};c(d);var e=f(d,a('[jq-ctrl="'+b+'"]'));g(e)};var g=function(f){f.bindings=[],f.onChangeTasks=[];var g=[],h=function(i){i.contents().andSelf().each(function(){if(-1===g.indexOf(this)){g.push(this);var i=b;for(var j in e)if(i|=e[j](this,f.model,f.onChangeTasks),i&d)break;i&c||h(a(this))}})};h(f.ctrl)};e.text=function(a,e,f){if("#"===a.nodeName.substr(0,1)&&a.data.match(/\{\{[\w\.]+\}\}/)){var g=a.data;return f.push(function(){a.data=g.replace(/\{\{([\w\.]+)\}\}/g,function(a,b){return e.get(b)})}),f[f.length-1](),c|d}return b},e.model=function(d,e,f){var g;return d.getAttribute&&(g=d.getAttribute("jq-model"))?(f.push(function(b){return d===b?!1:void a(d).val(e.get(g))}),f[f.length-1](),a(d).bind("keypress change keyup",function(){e.set(g,a(this).val());for(var b in f)f[b](this)}),c):b},e.jqAttribute=function(a,c,d){if("function"!=typeof a.getAttribute)return b;for(var e=["jq-src","jq-href"],f=function(a,b,e){d.push(function(){a.setAttribute(b.substr(3),e.replace(/\{\{([\w\.]+)\}\}/g,function(a,b){return c.get(b)}))})},g=0;g<e.length;g++){var h,i=e[g];(h=a.getAttribute(e[g]))&&(f(a,i,h),d[d.length-1]())}return b},e.otherAttribute=function(a,c,d){if("function"!=typeof a.getAttribute)return b;for(var e=a.attributes,f=function(a,b,e){d.push(function(){a.setAttribute(b,e.replace(/\{\{([\w\.]+)\}\}/g,function(a,b){return c.get(b)}))})},g=0;g<e.length;g++)if("jq-"!==e[g].name.substr(0,3)){var h=e[g].value,i=e[g].name;h.match(/\{\{([\w\.]+)\}\}/)&&(f(a,i,h),d[d.length-1](null))}return b},e.jqStyle=function(c,d,e){var f;return"function"==typeof c.getAttribute&&(f=c.getAttribute("jq-style"))?(e.push(function(){a(c).css(d.get(f))}),e[e.length-1](null),b):b},e.jqDisabled=function(c,d,e){var f;return"function"==typeof c.getAttribute&&(f=c.getAttribute("jq-disabled"))?(e.push(function(){a(c).attr("disabled",d.get(f))}),e[e.length-1](null),b):b},e.jqSelect=function(d,e,f){var g;if("SELECT"!==d.nodeName||!(g=d.getAttribute("jq-options")))return b;var h,i,j,k;if(h=g.match(/^(\w+)$/))i=null,j=null,k=h[1];else{if(!(h=g.match(/^(\w+),(\w+)\s+in\s+(\w+)$/)))return b;i=h[1],j=h[2],k=h[3]}return f.push(function(){a(d).empty();var b=d.getAttribute("jq-model"),c=e.get(k);if(c&&"object"==typeof c[0]&&1===Object.keys(c[0]).length&&c[0][Object.keys(c[0])[0]]instanceof Array)for(var f in c){var g=a("<optgroup></optgroup>"),h=Object.keys(c[f])[0];g.attr("label",h);var l=c[f][h];if(null===i)for(var m in l)g.append("<option>"+l[m]+"</option>");else for(var n in l)g.append('<option value="'+l[n][i]+'">'+l[n][j]+"</option>");a(d).append(g)}else if(null===i)for(var o in c)a(d).append("<option>"+c[o]+"</option>");else for(var p in c)a(d).append('<option value="'+c[p][i]+'">'+c[p][j]+"</option>");a(d).val(e.get(b))}),f[f.length-1](null),a(d).removeAttr("jq-options"),c},e.jqIf=function(c,d,e){var f;if("function"!=typeof c.getAttribute||!(f=c.getAttribute("jq-if")))return b;var g=document.createComment("jq-if "+f+" start"),h=document.createComment("jq-if "+f+" end"),i=a(c).parent()[0];return i.insertBefore(g,c),c.nextElementSibling?i.insertBefore(h,c.nextElementSibling):i.appendChild(h),e.push(function(){a(c).remove(),d.get(f)&&a(c).insertAfter(g)}),e[e.length-1](null),b},e.jqNot=function(c,d,e){var f;if("function"!=typeof c.getAttribute||!(f=c.getAttribute("jq-not")))return b;var g=document.createComment("jq-not "+f+" start"),h=document.createComment("jq-not "+f+" end"),i=a(c).parent()[0];return i.insertBefore(g,c),c.nextElementSibling?i.insertBefore(h,c.nextElementSibling):i.appendChild(h),e.push(function(){a(c).remove(),d.get(f)||a(c).insertAfter(g)}),e[e.length-1](null),b},e.jqRepeat=function(d,e,h){var i,j;if("function"!=typeof d.getAttribute||!(i=d.getAttribute("jq-repeat"))||!(j=i.match(/(\w+)\s+in\s+([\w\.]+)/)))return b;var k=j[2],l=j[1],m=document.createComment("jq-if "+i+" start"),n=document.createComment("jq-if "+i+" end"),o=a(d).prop("outerHTML"),p=a(d).parent()[0];p.insertBefore(m,d),d.nextElementSibling?p.insertBefore(n,d.nextElementSibling):p.appendChild(n);var q=function(b){var c=a(o.replace(/\{\{([\w\.]+)\}\}/g,function(a,c){return null!==b.get(c)?b.get(c):a}));c.removeAttr("jq-repeat");var d=f(b.getData(),c);return g(d),c};return h.push(function(){for(var b=m.nextSibling;b!==n;)b=b.nextSibling,a(b.previousSibling).remove();var c=e.get(k);for(var d in c){var f=e.clone();f.set(l,c[d]),q(f).insertBefore(n)}}),h[h.length-1](null),c};var h=function(b){"undefined"!=typeof b&&b||(b={});var c=b;this.set=function(a,b){var d=a.split("."),e=d.pop(),f=c;for(var g in d)"undefined"==typeof f[d[g]]&&(f[d[g]]={}),f=f[d[g]];return f[e]=b,b},this.get=function(a){var b=a.split("."),d=c;for(var e in b)if(d=d[b[e]],"undefined"==typeof d)return null;return d},this.subModel=function(a){return new h(this.get(a))},this.getData=function(){return c},this.clone=function(){return new h(a.extend(!0,{},c))}}});